# CloudPix - サーバーレス画像管理システム

CloudPixは、AWSのサーバーレスサービスを活用した画像アップロードと管理を行うシステムです。画像のアップロード、保存、メタデータ管理、一覧取得に加え、自動サムネイル生成機能も備えています。

## アーキテクチャ図

```
                                  ┌────────────────────┐
                                  │     S3 Event       │
                                  │    Notification    │
                                  └──────────┬─────────┘
                                             │
                                             ▼
┌─────────┐     ┌──────────────┐     ┌──────────────────┐     ┌───────────────┐
│         │     │              │     │ Lambda Functions  │     │   S3 Storage   │
│ クライアント │────▶│  API Gateway  │────▶│  - upload        │────▶│  - uploads/    │
│         │     │              │     │  - list          │     │  - thumbnails/  │
└─────────┘     └──────────────┘     │  - thumbnail     │     └───────────────┘
                        │             └──────────────────┘              │
                        │                       │                       │
                        ▼                       ▼                       │
                ┌──────────────┐       ┌───────────────┐                │
                │ CloudWatch   │       │   DynamoDB    │◀───────────────┘
                │    Logs      │       │   Tables      │
                └──────────────┘       └───────────────┘
```

## 主要コンポーネント

### 1. API Gateway
- RESTful APIエンドポイントを提供
- `/upload` - 画像アップロード用エンドポイント
- `/list` - 画像一覧取得用エンドポイント

### 2. Lambda 関数
- **cloudpix-upload** - 画像アップロード、S3保存、メタデータ登録を行う関数
- **cloudpix-list** - DynamoDBからメタデータを取得し画像一覧を提供する関数
- **cloudpix-thumbnail** - アップロードされた画像のサムネイルを自動生成する関数

### 3. S3バケット
- **cloudpix-images-{random_suffix}** - アップロードされた画像を保存
  - `uploads/` - 元の画像ファイル
  - `thumbnails/` - 自動生成されたサムネイル

### 4. DynamoDBテーブル
- **cloudpix-metadata** - 画像のメタデータを保存
  - `ImageID` (パーティションキー) - 画像の一意識別子
  - `UploadDate` (GSIキー) - アップロード日付によるクエリを可能にする
  - サムネイル情報も同じレコードに保存

### 5. S3イベント通知
- 画像がアップロードされると自動的にサムネイル生成関数を起動

### 6. ECRリポジトリ
- **cloudpix-upload** - アップロード関数用のコンテナイメージを格納
- **cloudpix-list** - 一覧表示関数用のコンテナイメージを格納
- **cloudpix-thumbnail** - サムネイル生成関数用のコンテナイメージを格納

## データフロー

### 画像アップロードフロー
1. クライアントが `/upload` エンドポイントにPOSTリクエストを送信
2. API GatewayがリクエストをLambda関数に転送
3. Lambda関数が:
   - 画像データを受け取る (Base64エンコード形式)
   - S3バケットに画像を保存
   - メタデータを生成しDynamoDBに保存
4. 保存結果とダウンロードURLをクライアントに返却

### サムネイル生成フロー
1. 画像が `uploads/` フォルダにアップロードされる
2. S3イベント通知が発生し、サムネイル生成Lambda関数が起動
3. Lambda関数が:
   - S3から元画像を取得
   - 画像処理ライブラリを使用してサムネイルを生成
   - サムネイルを `thumbnails/` フォルダに保存
   - DynamoDBのメタデータを更新してサムネイル情報を追加

### 画像一覧取得フロー
1. クライアントが `/list` エンドポイントにGETリクエストを送信
2. API GatewayがリクエストをLambda関数に転送
3. Lambda関数がDynamoDBからメタデータを取得
4. 画像メタデータの一覧をクライアントに返却
   - オリジナル画像とサムネイル両方のURLを含む

## プロジェクト構成

```
cloudpix/
  ├── terraform/           # Terraformによるインフラ定義
  │   ├── api_gateway.tf   # API Gateway定義
  │   ├── dynamodb.tf      # DynamoDBテーブル定義
  │   ├── ecr.tf           # ECRリポジトリ定義
  │   ├── iam.tf           # IAMロールとポリシー定義
  │   ├── lambda.tf        # Lambda関数定義
  │   ├── main.tf          # メインのTerraform設定
  │   ├── outputs.tf       # 出力値の定義
  │   ├── providers.tf     # プロバイダー設定
  │   ├── s3.tf            # S3バケット設定
  │   ├── thumbnail.tf     # サムネイル生成機能の定義
  │   └── variables.tf     # 変数定義
  ├── cmd/                 # Goのソースコード
  │   ├── upload/          # アップロード関数
  │   │   └── main.go
  │   ├── list/            # 一覧取得関数
  │   │   └── main.go
  │   └── thumbnail/       # サムネイル生成関数
  │       └── main.go
  ├── Dockerfile           # コンテナイメージ定義
  ├── build_and_push.sh    # イメージビルドスクリプト
  ├── go.mod               # Go依存関係
  └── Makefile             # タスク自動化
```

## 実装機能

- **画像アップロード** - Base64エンコードされた画像データをアップロード
- **プレサインドURL** - S3への直接アップロード用URLの生成
- **メタデータ管理** - 画像のファイル名、サイズ、コンテンツタイプなどを管理
- **画像一覧取得** - アップロードされた画像の一覧取得
- **日付フィルタリング** - アップロード日付による画像の絞り込み
- **自動サムネイル生成** - 画像アップロード時にサムネイルを自動生成
- **イベント駆動型処理** - S3イベント通知による非同期処理

## コマンド一覧

```bash
# インフラのデプロイ
make tf-apply

# APIのテスト - 画像アップロード
make test

# APIのテスト - 画像一覧取得
make test-list

# アップロード関数のコード更新
make update-code

# リスト関数のコード更新
make update-list-code

# サムネイル関数のコード更新
make update-thumbnail-code
```

## 今後の拡張予定

- 画像検索機能（タグ付けなど）
- 画像処理機能の拡張（サイズ変更、フィルター適用など）
- ユーザー認証
- フロントエンドインターフェース